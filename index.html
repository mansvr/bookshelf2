<!DOCTYPE html>
<html>
<head>
    <title>My Bookshelf</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/anim.css">
</head>
<body>
    <!-- Theme Toggle -->
    <div class="theme-toggle">
        <button id="themeToggle" class="theme-toggle-btn" aria-label="Toggle theme">
        <svg class="sun-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="5"></circle>
            <line x1="12" y1="1" x2="12" y2="3"></line>
            <line x1="12" y1="21" x2="12" y2="23"></line>
            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
            <line x1="1" y1="12" x2="3" y2="12"></line>
            <line x1="21" y1="12" x2="23" y2="12"></line>
            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
        </svg>
        <svg class="moon-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
        </svg>
        </button>
    </div>

    <div class="bookshelf-wrapper">
        <div class="container" id="bookshelf">
            <h1>Loading bookshelf...</h1>
        </div>
    </div>

    <script>
        // Theme toggle
        const themeToggle = document.getElementById('themeToggle');
        const savedTheme = localStorage.getItem('bookshelf-theme') || 'light';
        document.body.setAttribute('data-theme', savedTheme);

        themeToggle.addEventListener('click', () => {
            const currentTheme = document.body.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.body.setAttribute('data-theme', newTheme);
            localStorage.setItem('bookshelf-theme', newTheme);
        });

        // Load and render books
        fetch('/books.json?v=' + Date.now())
            .then(response => {
                console.log('Response status:', response.status);
                if (!response.ok) {
                    throw new Error('Failed to load books.json: ' + response.status);
                }
                return response.json();
            })
            .then(books => {
                console.log('Loaded books:', books.length);
                const container = document.getElementById('bookshelf');
                container.innerHTML = '';

                // Calculate total width and max height
                let totalWidth = 0;
                let maxHeight = 0;
                books.forEach(book => {
                    const thickness = book.nonlinear_thickness || 20;
                    const height = 200 / (book.aspect_ratio || 0.67);
                    totalWidth += thickness;
                    maxHeight = Math.max(maxHeight, height);
                });

                // Set container dimensions
                container.style.perspective = '800px';
                container.style.height = '300px';
                container.style.width = (totalWidth + 400) + 'px';

                // Render each book with positioning
                let offset = 0;
                books.forEach((book, index) => {
                    // Calculate dimensions
                    const pages = book.nonlinear_thickness || 20; // Thickness in pixels (NOT page count!)
                    const aspectRatio = book.aspect_ratio || 0.67;
                    const bookHeight = 200 / aspectRatio;
                    
                    // Create book container with positioning
                    const bookContainer = document.createElement('div');
                    bookContainer.className = 'book-container';
                    bookContainer.style.transform = `translateX(${offset + pages/2}px) translateY(${maxHeight - bookHeight}px)`;
                    
                    // Create book element
                    const bookDiv = document.createElement('div');
                    bookDiv.id = `book-${book.id}`;
                    bookDiv.className = 'book';
                    bookDiv.style.width = '200px';
                    bookDiv.style.height = bookHeight + 'px';
                    bookDiv.style.transform = 'rotateY(90deg)';
                    bookDiv.style.setProperty('--thickness', pages + 'px');
                    bookDiv.onclick = function() {
                        toggleBook(this.id);
                    };

                    bookDiv.innerHTML = `
                        <img class="cover" src="${book.cover_url}" 
                             alt="${book.title}"
                             style="width: 200px; height: ${bookHeight}px; transform: translateZ(${pages/2}px)"
                             onerror="this.style.backgroundColor='${book.cover_color}'; this.style.display='flex'; this.style.alignItems='center'; this.style.justifyContent='center'; this.innerHTML='${book.title}';">
                        </img>
                        <div class="spine" style="width: ${pages}px; height: ${bookHeight}px; background: ${book.cover_color || '#8B4513'} linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.1) 20%, rgba(255,255,255,0.1) 80%, rgba(255,255,255,0) 100%); color: ${book.cover_contrast || '#eee'}; line-height: ${pages}px; transform: translateX(-${pages/2}px) translateY(-${bookHeight}px) rotateY(-90deg);">
                            <div class="spinetext" style="width: 100%; height: ${bookHeight}px;">
                                <span class="title">${book.title || ''}</span><br>
                                <span class="author">${book.author || ''}</span>
                            </div>
                        </div>
                        <div class="back" style="color: ${book.cover_contrast || '#eee'}; width: 200px; height: ${bookHeight}px; background: ${book.cover_color || '#8B4513'}; transform: translateY(-${bookHeight * 2}px) translateZ(-${pages/2}px) rotateY(180deg);">
                            <div style="width: 184px; height: ${bookHeight - 24}px; overflow: hidden; padding: 8px;">${book.description || 'No description available.'}</div>
                            <div style="width: 184px; height: 8px; text-align: center; padding: 0 8px;">
                                ${book.book_url ? `<a href="${book.book_url}" target="_blank" rel="noopener noreferrer" style="float:left;color:${book.cover_contrast || '#eee'}">View</a>` : ''}
                                <span style="float:right;">${book.page_count || '?'} pages</span>
                            </div>
                        </div>
                        <div class="side left" style="width: ${pages}px; height: ${bookHeight}px; background-color: ${book.cover_color || '#8B4513'}; transform: translateZ(-${pages/2}px) rotateY(90deg);"></div>
                        <div class="side right" style="width: ${pages}px; height: ${bookHeight}px; background-color: ${book.cover_color || '#8B4513'}; transform: translateX(200px) translateZ(-${pages/2}px) translateY(-${bookHeight}px) rotateY(90deg);"></div>
                        <div class="side top" style="width: 200px; height: ${pages}px; background-color: ${book.cover_color || '#8B4513'}; transform: translateY(-${bookHeight}px) translateZ(-${pages/2}px) rotateX(90deg);"></div>
                        <div class="side bottom" style="width: 200px; height: ${pages}px; background-color: ${book.cover_color || '#8B4513'}; transform: translateY(-${bookHeight * 2}px) translateZ(${pages/2}px) rotateX(90deg);"></div>
                        <div class="pages" style="width: ${pages - 1}px; height: ${bookHeight - 6}px; background: #f1f1f1; transform: translateY(-${bookHeight * 3 - 3}px) translateX(${200 - pages/2 - 3}px) rotateY(90deg);"></div>
                    `;

                    bookContainer.appendChild(bookDiv);
                    container.appendChild(bookContainer);
                    offset += pages;
                });

                // Add book interaction functions
                function replaceOtherBooks(book) {
                    const books = document.querySelectorAll('.book');
                    for (let i = 0; i < books.length; ++i) {
                        if (books[i] != book) {
                            if (books[i].className == "book book-show") {
                                books[i].className = "book book-showaway";
                            } else if (books[i].className == "book book-showback") {
                                books[i].className = "book book-putaway";
                            }
                        }
                    }
                }

                window.toggleBook = function(bookId) {
                    const book = document.getElementById(bookId);
                    if (!book) return;
                    
                    replaceOtherBooks(book);
                    
                    if (book.className == "book") {
                        book.className = "book book-show";
                    } else if (book.className == "book book-putaway") {
                        book.className = "book book-show";
                    } else if (book.className == "book book-showaway") {
                        book.className = "book book-show";
                    } else if (book.className == "book book-show") {
                        book.className = "book book-showback";
                    } else if (book.className == "book book-showback") {
                        book.className = "book book-putaway";
                    } else {
                        book.className = "book";
                    }
                };
            })
            .catch(error => {
                console.error('Error loading books:', error);
                document.getElementById('bookshelf').innerHTML = `
                    <div style="padding: 20px; text-align: center;">
                        <h1>Error loading bookshelf</h1>
                        <p style="color: #ff6b6b;">${error.message}</p>
                        <p>Check the console for more details (F12)</p>
                        <p>Trying to load from: <code>${window.location.origin}/books.json</code></p>
                    </div>
                `;
            });
    </script>
</body>
</html>

